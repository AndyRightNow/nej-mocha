#!/usr/bin/env node

var spawn = require('child_process').spawn;
var path = require('path');

var server = require('./../server');
var config = require('./../config');
var userConfig = require('./../src/get-user-config');

// Normalize user config 
var runnerConfig = Object.create(null);
runnerConfig.useColors = true;
runnerConfig.timeout = userConfig.timeout === undefined ? 3000 : userConfig.timeout;

var runnerCwd = path.resolve(__dirname, "../", "../", "../");

var testRunnerProcess = spawn("node", [
    config.phantomJSPath,
    config.mochaPhantomJSCorePath,
    `http://localhost:${config.PORT}/${config.TEST_INDEX}`,
    config.defaultReporter,
    JSON.stringify(runnerConfig)
], {
    cwd: runnerCwd
});

testRunnerProcess.stdout.on('data', (data) => {
    var str = data.toString('utf-8');

    if (/do\s/.test(str)) {
        return;
    }

    console.log(str);
});

testRunnerProcess.stderr.on('data', (data) => {
    console.log(`ERROR: ${data.toString('utf-8')}`);
});

testRunnerProcess.on('close', (code) => {
    console.log(`All tests are finished.`);
    server.close();
});