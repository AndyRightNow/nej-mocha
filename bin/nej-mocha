#!/usr/bin/env node

var spawn = require('child_process').spawn;
var path = require('path');

var config = require('./../config');

var cwd = path.resolve(__dirname, "../");

var testServerProcess = spawn("node", ["./server.js"], {
    cwd: cwd
});

testServerProcess.stdout.on('data', (data) => {
    console.log(data.toString('utf-8'));
});

testServerProcess.stderr.on('data', (data) => {
  console.log(`stderr: ${data.toString('utf-8')}`);
});

var testRunnerProcess = spawn("node", ["./node_modules/phantomjs-prebuilt/bin/phantomjs", "./node_modules/mocha-phantomjs-core/mocha-phantomjs-core.js", "http://localhost:" + config.PORT +"/testIndex", "spec","{\"useColors\":true}"], {
    cwd: cwd
});

testRunnerProcess.stdout.on('data', (data) => {
    console.log(data.toString('utf-8'));
});

testRunnerProcess.stderr.on('data', (data) => {
  console.log(`stderr: ${data.toString('utf-8')}`);
});

testRunnerProcess.on('close', (code) => {
  console.log(`Test Runner Process exited with code ${code}`);
  testServerProcess.kill(0)
});
