#!/usr/bin/env node

var spawn = require('child_process').spawn;
var path = require('path');

var server = require('./../server');
var config = require('./../config');

var runnerCwd = path.resolve(__dirname, "../", "../", "../");


var testRunnerProcess = spawn("node", ["./node_modules/phantomjs-prebuilt/bin/phantomjs", "./node_modules/mocha-phantomjs-core/mocha-phantomjs-core.js", "http://localhost:" + config.PORT + "/testIndex", "spec", "{\"useColors\":true}"], {
    cwd: runnerCwd
});

testRunnerProcess.stdout.on('data', (data) => {
    var str = data.toString('utf-8');

    if (/do\s/.test(str)) {
        return;
    }

    console.log(str);
});

testRunnerProcess.stderr.on('data', (data) => {
    console.log(`ERROR: ${data.toString('utf-8')}`);
});

testRunnerProcess.on('close', (code) => {
    console.log(`All tests are finished.`);
    server.close(() => {
    });
});